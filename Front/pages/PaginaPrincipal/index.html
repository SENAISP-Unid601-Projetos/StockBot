<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>StockBot - Dashboard Inteligente</title>
    <link rel="stylesheet" href="styles/style.css"> 
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <nav class="sidebar">
        <button id="sidebar-toggle" class="sidebar-toggle">S</button>
        <h2>StockBot</h2>
        <a href="#" class="nav-link active"> <i data-lucide="layout-dashboard"></i> <span>Dashboard</span>
        </a>
        <a href="../CadastroDeComponentes/index.html" class="nav-link">
            <i data-lucide="wrench"></i>
            <span>Componentes</span>
        </a>
        <a href="#" class="nav-link">
            <i data-lucide="history"></i> <span>Histórico</span>
        </a>
        <div style="flex-grow: 1;"></div>
        <a href="#" class="nav-link">
            <i data-lucide="settings"></i> <span>Configurações</span>
        </a>
        <a href="#" class="nav-link">
            <i data-lucide="circle-user-round"></i>
            <span>Sair/Entrar</span>
        </a>
    </nav>

    <main class="main main-content">
        <div class="header-dashboard">
            <div class="header-title">
                <h1>Dashboard</h1>
                <p>Olá, Usuário! Aqui está um resumo inteligente do seu estoque.</p>
            </div>
            <div class="header-controls">
                <div class="search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" placeholder="Pesquisar componente...">
                </div>
                <div class="date-filter">
                    <i data-lucide="calendar"></i>
                    <select>
                        <option>Últimos 30 dias</option>
                        <option>Últimos 7 dias</option>
                        <option>Este mês</option>
                        <option>Este trimestre</option>
                    </select>
                </div>
            </div>
        </div>
    
        <div class="dashboard-grid">
            <div class="kpi-card">
                <div class="card-header">
                    <span>Total de Componentes</span>
                    <i data-lucide="package-search"></i>
                </div>
                <span class="number">--</span>
                <span class="description">Carregando dados...</span>
            </div>
            <div class="kpi-card">
                <div class="card-header">
                    <span>Itens em Estoque</span>
                    <i data-lucide="archive"></i>
                </div>
                <span class="number">--</span>
                <span class="description">Carregando dados...</span>
            </div>
            <div class="kpi-card critical" id="kpi-falta">
                <div class="card-header">
                    <span>Itens em Falta</span>
                    <i data-lucide="alert-triangle"></i>
                </div>
                <span class="number">--</span>
                <span class="description">Carregando dados...</span>
            </div>
        </div>
        
        <div class="section-title">
            <i data-lucide="zap"></i>
            <h2>Ação Imediata</h2>
        </div>
        <div class="action-grid">
            <div class="action-card">
                <h3><i data-lucide="x-circle"></i>Itens em Falta (Estoque Zerado)</h3>
                <ul id="lista-itens-falta">
                    <p style="text-align: center;">Carregando...</p>
                </ul>
            </div>
            <div class="action-card">
                <h3><i data-lucide="alert-circle"></i>Itens com Estoque Baixo</h3>
                <ul id="lista-estoque-baixo">
                    <p style="text-align: center;">Carregando...</p>
                </ul>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Componentes por Categoria</h3>
                <canvas id="graficoCategorias"></canvas>
            </div>
        </div>
        
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Lógica do Sidebar Retrátil ---
            lucide.createIcons();
            const toggleButton = document.getElementById('sidebar-toggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            toggleButton.addEventListener('click', () => {
                sidebar.classList.toggle('retracted');
                mainContent.classList.toggle('expanded');
            });

            // --- Lógica para buscar e exibir os dados (o que já tínhamos) ---
            const apiUrl = 'http://localhost:8080/api/componentes';

            async function fetchAndRenderDashboardData() {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error('Erro ao buscar dados do back-end.');
                    }
                    const componentes = await response.json();

                    // 1. Atualizar KPIs e remover texto de "Carregando dados..."
                    document.querySelector('.kpi-card:nth-child(1) .number').textContent = componentes.length;
                    document.querySelector('.kpi-card:nth-child(1) .description').textContent = "Componentes cadastrados";

                    const totalUnidades = componentes.reduce((total, comp) => total + comp.quantidade, 0);
                    document.querySelector('.kpi-card:nth-child(2) .number').textContent = totalUnidades;
                    document.querySelector('.kpi-card:nth-child(2) .description').textContent = "Unidades totais";

                    const itensEmFalta = componentes.filter(comp => comp.quantidade <= 0);
                    document.querySelector('.kpi-card.critical .number').textContent = itensEmFalta.length;
                    document.querySelector('.kpi-card.critical .description').textContent = "Ação imediata necessária";

                    // 2. Atualizar a lista de "Itens em Falta"
                    const listaItensFalta = document.getElementById('lista-itens-falta');
                    listaItensFalta.innerHTML = '';
                    if (itensEmFalta.length > 0) {
                        itensEmFalta.forEach(comp => {
                            const li = document.createElement('li');
                            li.innerHTML = `${comp.nome} <span class="badge red">${comp.quantidade} un.</span>`;
                            listaItensFalta.appendChild(li);
                        });
                    } else {
                        listaItensFalta.innerHTML = '<li><p style="text-align: center;">Nenhum item em falta.</p></li>';
                    }

                    // 3. Atualizar a lista de "Estoque Baixo"
                    const itensEstoqueBaixo = componentes.filter(comp => comp.quantidade > 0 && comp.quantidade <= 5);
                    const listaEstoqueBaixo = document.getElementById('lista-estoque-baixo');
                    listaEstoqueBaixo.innerHTML = '';
                    if (itensEstoqueBaixo.length > 0) {
                        itensEstoqueBaixo.forEach(comp => {
                            const li = document.createElement('li');
                            li.innerHTML = `${comp.nome} <span class="badge orange">${comp.quantidade} un.</span>`;
                            listaEstoqueBaixo.appendChild(li);
                        });
                    } else {
                        listaEstoqueBaixo.innerHTML = '<li><p style="text-align: center;">Nenhum item com estoque baixo.</p></li>';
                    }
                    
                    // 4. Popular o gráfico de categorias
                    const categorias = {};
                    componentes.forEach(comp => {
                        categorias[comp.categoria] = (categorias[comp.categoria] || 0) + comp.quantidade;
                    });
                    
                    const graficoCategorias = document.getElementById('graficoCategorias');
                    const labels = Object.keys(categorias);
                    const data = Object.values(categorias);

                    if(graficoCategorias) {
                        new Chart(graficoCategorias, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Quantidade por Categoria',
                                    data: data,
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.8)',
                                        'rgba(75, 192, 192, 0.8)',
                                        'rgba(255, 206, 86, 0.8)',
                                        'rgba(255, 99, 132, 0.8)',
                                        'rgba(153, 102, 255, 0.8)'
                                    ],
                                    hoverOffset: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'top' } }
                            }
                        });
                    }

                } catch (error) {
                    console.error('Erro ao carregar dados do dashboard:', error);
                    document.querySelector('.dashboard-grid').innerHTML = '<h2 style="color: red; text-align: center;">Não foi possível carregar os dados.</h2>';
                }
            }

            fetchAndRenderDashboardData();
        });
    </script>
</body>
</html>